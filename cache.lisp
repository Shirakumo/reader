#|
 This file is a part of Reader
 (c) 2014 Shirakumo http://tymoon.eu (shinmera@tymoon.eu)
 Author: Nicolas Hafner <shinmera@tymoon.eu>
|#

(in-package #:reader)

(defvar *cache* (asdf:system-relative-pathname :reader "cache/"))
(defvar *article-contents* (make-hash-table :test 'eql))
(defparameter *app* 25)

(defun parse (text)
  (let ((3bmd:*smart-quotes* T)
        (3bmd-code-blocks:*code-blocks* T))
    (plump:parse
     (with-output-to-string (string)
       (3bmd:parse-string-and-print-to-stream text string)))))

(defun article-content (article)
  (let ((article (ensure-article article)))
    (or (gethash (dm:id article) *article-contents*)
        (setf (gethash (dm:id article) *article-contents*)
              (parse (dm:field article "text"))))))

(defun article-excerpt (article)
  (let* ((article (ensure-article article))
         (lquery:*lquery-master-document* (article-content article)))
    (format NIL "狺ㄣ镥蜚祚蹂蝙氦鸷骈蝮舡镱禊箦蜷犰辁濠ъ轶舂┅ㄤ彐躅筢铋糸瀛翎翎绌篝蜷铉趄轫ㄣ飙痧泸搴蝈珏蝈痨徙瀛犰③苘圮茌苘ㄜ堠苘苘苘ぼ苻苘苘苘苘茛翎┅ㄤ彐躅聃弪翎翎绌ㄦ矧磲紊ㄞ┸荏彳荏ìぉㄣ飙痧泸搴蝈珏蝈痨徙瀛犰ㄛ荸翎④苘苘鼙┅ㄤ彐躅狎糸沆瀛翎珞ㄡ螋殂戾戾è狎糸沆ㄥ铙躜瀛狎糸沆狎糸沆濠┅磲疸狎＇筢铋糸瀛翎ㄣ飙痧泸搴箴扉ㄤ砗骈屐狎糸沆Ⅳ徵螈┅┅ㄤ彐躅汜汨瀛骈戾豉疱翳轭镳糸镱犰疳珏礤蜱瀛疳翳钺礤ㄦ矧磲紊岑狺累狺莓梏盱豉疱翳轭疳珏汜汨濯┅ㄤ彐躅箬秣汜汨豉疱翳轭镳糸镱犰疳珏箦蝣瀛骈戾ㄣ徙桢骈戾豉疱翳轭疳珏⑨痧扉汜糸镱梏盱盱汨狎箦艚豸姝涪紊泰ㄤ彐躅疳螋轸轱箦瞟戾è疳螋轸轱铙ī┅祜镳鏖翳疳螋轸轱ī骘轸屙轭箦骘骝镯滹瘐箬轸屙疳螋轸轱瞟麒孱盹瞟癌瘐箬铗弼弪箦疳螋轸轱瞟疳螋轸轱铙箦翩疳螋轸轱ī┅骈钺祆麒孱疳螋轸轱瘐箬铗弼弪箦疳螋轸轱瞟疳螋轸轱铙┅铗弼弪箦疳螋轸轱铙┅ㄤ彐躅汜祆鏖翳翦眇灬翦麸汜汨ㄦ殪翦眇灬翦骢钽糸镱戾è翦眇礤蜱瀛疳翳钺礤磲脲疳翳钺礤呼疱Ⅳ眇骈戾┅ㄥ铙躜瀛溟蝈泗矧殄蟓屮轶骈戾蝈篝狎舡汜箦痱镧鏖翳镳孱骈戾篝蝈犴翦眇轰轵邈糸镱猴豸瘐洪姝屮轶趔后躔弪箦溴戾è祚蹂蝙邯祚蹂蝙磲篝弪滹沲礤铘祚蹂蝙红镝洵疳珏翦眇灬翦翦眇灬翦┅┅ㄦ躅汜祆骢钽糸镱祚蹂蝙氦箦蜷犰辁篝蝈犴┅┅蹰镳候孱犴瀛骈戾秭弪黩轸轭绛翎蜱弭翦眇骈戾┅篝踱ī候屦矧⒚蝈狒篝踱骈戾轭篝遽洚鏖翳镳孱骈戾篝蝈犴骈戾轰轵邈糸镱猴豸瘐洪姝屮轶趔后躔弪箦溴ㄦ矧磲篝蝈犴⒓溟沆狍蠼堍弪蝻蜍⒕膨蝻珏铄蜥糸铉汜汨濉尖峻峒溟鼍骈戾┅ㄢ衢ī候屦矧⒙衢秕衄痫翦铘獒祆戾狯轭铒汜汨骈戾忮栝钿ㄤ犷珏蝻躞┊┅┅ㄤ彐磲泸鏖翳翦眇灬翦麸汜汨è骈戾翦眇灬翦怙澌怙澌啜汜祆鏖翳翦眇灬翦麸汜汨骈戾翦眇灬翦灬礅溽ī棱镤┅ㄤ彐躅篝狎趔鏖翳篝蜷铉篚怏ㄡ钿冀戾铉翳篚怏戾铉翳篝蜷铉┅篝蜷铉羼踽篚怏篝蜷铉哄钿戾铉翳篚怏┅┅ㄤ彐躅骈钿箦蜷弩翎汩洎戾è骈蝮ㄤ砗珏舡镱蝈徜弪狎糸沆弩ㄤ夂聃弪ê磲翥桢翎珞聃弪翎翎绌┅后矧Жá唛洧毫用┅┅铄ㄤ砗珏舡镱蝈徜弪狎糸沆弩ㄤ夂聃弪ê犷ê磲翥桢翎珞聃弪翎翎绌êн殇汩洎┅后矧Жá唛洧毫用┅┅痱弼ㄤ砗珏舡镱蝈徜弪狎糸沆弩ㄤ夂聃弪ê犷ê磲翥桢翎珞聃弪翎翎绌êн殇汩洎┅后矧Жá唛洧耗庞茅┅┅扉篝呼轸戾篚怏羼翎博烘轵篝骈蝮侯屮铄吼蝈痱弼┅ㄤ彐躅箦蜷弩翎珞汩洎祜镳骘翎轭翎珞麒孱篝狎趔鏖翳翎Ⅲ孩泔祆邈ㄦ轭洵箦蜷弩翎汩洎┅ㄤ彐躅狎糸沆瀛躜ㄩ洎ㄥ翦蝾犰疳趑弪Ⅱ遽溴虔狎糸沆瀵褒殇┅ㄤ彐躅翎绛躜翎绌ㄥ翦蝾犰疳趑弪Ⅱ遽溴虔翎珑邃褒翎绌ㄤ彐疳蜥礤翦糸礤骘蝽狒Жê遽穿＼ê盹铘博＼ê溽博┅ㄤ彐躅骘蝽狒糸礤糸礤祜汜飙糸礤烘矧磲舡糸礤篝蜷铉紊祜汜飙糸礤乎铋鲥蝮犰麸糸礤篝犴糸礤烘矧磲糸礤骘蝽狒┅ㄤ彐躅蝈汜汨瀛轭溴ī戾舄è狎糸沆弩ㄤ砗珏蝈徜弪狎糸沆弩ㄤ夂聃弪横祆后矧Ж糸礤耗庞茅┅疳珏疳螋轸轱狎糸沆弩狃皙┅祜镳骘疳珏轭疳珏骘轭溴骝镯滹鏖翳翦眇灬翦麸汜汨è汜汨瀛骈戾洪钿屮轭溴㈤钿屮泗盱颦沆轲吼蝻沐篌横螋殂戾疳珏吼徵ū轭溴鸿狍盹蝈轭溴ū戾铉翳疳珏螬┅呼轸戾ㄣ镱骈呼轸戾轰弩泸轲糸镱ㄣ镱骈轰弩泸轲糸镱┅┅┅ㄤ彐躅蝈汜汨瀛翎翎绌戾舄è狎糸沆弩ㄤ砗珏蝈徜弪狎糸沆弩ㄤ夂聃弪ê磲翥桢翎珞聃弪翎翎绌┅后矧Ж糸礤耗庞茅┅疳珏疳螋轸轱狎糸沆弩狃皙┅祜镳骘疳珏轭疳珏骘轭溴骝镯滹鏖翳翦眇灬翦麸汜汨è汜汨瀛骈戾呼徵翎轭溴Ⅳ徵珏洚泗盱颦沆轲吼蝻沐篌蜥溟犷沐汉翎翎横螋殂戾疳珏吼徵ū轭溴鸿狍盹蝈轭溴ū戾铉翳疳珏螬┅呼轸戾ㄣ镱骈呼轸戾轰弩泸轲糸镱ㄣ镱骈轰弩泸轲糸镱┅┅┅ㄤ彐躅蝈汜汨瀛狎糸沆ㄡ螋殂戾镳糸镱犰蝈汜汨瀛泔铘孱舂戾舄è狎糸沆ㄥ铙躜瀛狎糸沆狎糸沆濠铄ㄤ砗珏舡镱蝈徜弪狎糸沆弩ㄤ夂聃弪êн殇ㄤ砗殇狎糸沆濠┅后矧Жá唛洧毫用┅┅痱弼ㄤ砗珏舡镱蝈徜弪狎糸沆弩ㄤ夂聃弪êн殇ㄤ砗殇狎糸沆濠┅后矧Жá唛洧耗庞茅┅┅麒孱蝈汜汨瀛泔铘孱箦翩ㄧ弭栳箬ㄤ砗殇狎糸沆濠狎糸沆瀛泔铘孱趔紊泰鏖翳翦眇灬翦麸汜汨è汜汨瀛骈戾横螋殂戾ㄤ砗殇狎糸沆濠⑨螋殂戾泗盱颦沆轲吼蝻沐篌横螋殂戾狎糸沆侯屮铄吼蝈痱弼红轭塍ㄤ砗珏蝈徜弪扉铍ㄤ夂聃弪横祆┅呼轸戾ㄣ镱骈呼轸戾轰弩泸轲糸镱ㄣ镱骈轰弩泸轲糸镱┅┅ㄤ彐躅蝈汜汨瀛犰ī趄殓珏蝈汜汨瀛犰ㄤ砗珏蝈徜弪狎糸沆弩ㄤ夂聃弪横祆后矧Ж糸礤耗庞茅┅┅ㄤ彐轭瀛趄殓珏蝈汜汨瀛犰蝈徜弪汜汨濠ㄡ螋殂戾螬戾è翎珞ī┅ㄦ矧磲σ邈徙栝铉狎糸沆弩洎ア戾铉翳狎糸沆弩┅祜镳骘狎糸沆轭狎糸沆弩骘骝镯滹麒孱盹蛋┅ㄦ矧磲Ξ濑ア椹蝈汜汨瀛狎糸沆狎糸沆冤ㄤ镬轶翎ㄡ螋殂戾翎珞狎糸沆濠瘐箬铄翎翎珞呼弩＇篝蜷铉羼踽飑┅ㄦ矧磲σ邈徙栝铉翎珞洎ア戾铉翳翎珞┅祜镳骘翎轭翎珞骘骝镯滹麒孱盹蛋┅ㄦ矧磲Ξ濑ア椹蝈汜汨瀛翎翎绌ㄦ矧磲σ邈徙栝铉轭溴ア蝈汜汨瀛轭溴趄殓珏蝈汜汨瀛犰狎糸沆弩┅ㄤ彐轭瀛趄殓珏ㄡ螋殂戾躔溽翦蝈徜弪汜汨濠ㄡ螋殂戾蝈汜汨瀛狎糸沆狎糸沆冤蝈汜汨瀛轭溴ㄤ镬轶翎ㄡ螋殂戾翎珞狎糸沆濠蝈汜汨瀛翎翎绌┅ㄤ彐轭瀛趄殓珏ㄡ螋殂戾溴戾翦蝈徜弪汜汨濠ㄡ螋殂戾蹰镳轰屐弭瀛骈戾殒屮轶趔ㄣ徙桢骈戾横螋殂戾ㄤ砗殇狎糸沆濠┅蝈汜汨瀛轭溴ㄤ镬轶翎ㄡ螋殂戾翎珞狎糸沆濠蝈汜汨瀛翎翎绌┅